<!-- =========================
Easy Cart (Local Only)
- Sync/Password removed
- Uses only localStorage
- File: edit.html
========================= -->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Easy Cart ‚Ä¢ Edit</title>
  <link rel="apple-touch-icon" href="icon.png">
  <link rel="icon" sizes="192x192" href="icon.png">
  <meta name="theme-color" content="#166534">
  <style>
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,sans-serif;margin:0;background:#f5f6f8;color:#111}
    header.card{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid #e5e7eb}
    .wrap{max-width:960px;margin:0 auto;padding:12px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:12px;margin:12px 0}
    .row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .muted{color:#6b7280;font-size:12px}
    .grow{flex:1}
    input,button{border:1px solid #d1d5db;background:#fff;border-radius:10px;padding:10px 12px;font-size:14px}
    button{cursor:pointer}
    .primary{background:#166534;color:#fff;border-color:#166534}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid #cbd5e1;background:#f8fafc;cursor:pointer;font-size:12px}
    .chip.active{border-color:#16a34a;background:#ecfdf5}
    .list{display:grid;grid-template-columns:1fr;gap:8px}
    @media(min-width:720px){.list{grid-template-columns:1fr 1fr}}
    .item{display:flex;align-items:center;gap:10px;padding:10px;border:1px solid #e5e7eb;border-radius:12px;background:#fff}
    .badges{display:flex;gap:6px;flex-wrap:wrap}
    .badge{font-size:11px;padding:2px 8px;border-radius:999px;border:1px solid #d1d5db;background:#f3f4f6;color:#374151}
    a.back{font-size:12px;border:1px solid #d1d5db;border-radius:10px;padding:6px 10px;text-decoration:none;color:#374151;background:#fff}
    dialog{border:none;border-radius:16px;max-width:520px;width:calc(100% - 24px);padding:0;box-shadow:0 10px 30px rgba(0,0,0,.18)}
    dialog::backdrop{background:rgba(0,0,0,.25)}
    .dlg-body{padding:16px}
    .dlg-head{padding:14px 16px;border-bottom:1px solid #e5e7eb;font-weight:600}
    .dlg-foot{display:flex;justify-content:flex-end;gap:8px;padding:12px 16px;border-top:1px solid #e5e7eb;background:#f8fafc;border-radius:0 0 16px 16px}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
  </style>
</head>
<body>
<header class="card">
  <div class="wrap row" style="justify-content:space-between">
    <div class="row" style="gap:10px">
      <a href="index.html" class="back">‚Üê Main</a>
      <strong>Edit</strong>
    </div>
    <div class="row" style="gap:8px">
      <button id="exportBtn">Export</button>
      <input id="importFile" type="file" accept="application/json" style="display:none">
      <button id="importBtn">Import</button>
      <button id="saveBtn" class="primary">Save & Exit</button>
    </div>
  </div>
</header>

<main class="wrap">
  <section class="card">
    <h3>Manage Markets</h3>
    <div class="row">
      <input id="marketInput" class="grow" placeholder="New market name (e.g., Walmart)" />
      <button id="addMarketBtn" class="primary">Ôºã Add Market</button>
    </div>
    <div id="marketList" class="row" style="gap:8px;flex-wrap:wrap;margin-top:8px"></div>
    <div class="muted">Click a chip to rename. Click the trash icon to delete.</div>
  </section>

  <section class="card">
    <h3>Add Items</h3>
    <div class="row">
      <input id="itemInput" class="grow" placeholder="e.g., Milk, Eggs, Banana (comma-separated) ‚Äî typing here filters the list below" />
      <button id="addItemBtn" class="primary">Ôºã Add</button>
    </div>
    <div class="row" style="margin-top:8px">
      <span class="muted">Assign to market(s):</span>
      <div id="marketChipsAdd" class="row" style="gap:6px;flex-wrap:wrap"></div>
    </div>
  </section>

  <section class="card">
    <h3>Manage Items</h3>
    <div id="items" class="list"></div>
  </section>
</main>

<template id="itemTpl">
  <div class="item">
    <div class="grow">
      <strong class="name"></strong>
      <div class="badges" style="margin-top:6px"></div>
    </div>
    <button class="edit">‚úèÔ∏è</button>
    <button class="del">üóë</button>
  </div>
</template>

<dialog id="itemEditor">
  <div class="dlg-head">Edit Item</div>
  <div class="dlg-body">
    <div class="row" style="gap:10px;flex-direction:column;align-items:stretch">
      <div>
        <label class="muted">Name</label>
        <input id="ieName" placeholder="Item name" />
      </div>
      <div>
        <div class="row" style="justify-content:space-between;align-items:center">
          <label class="muted">Markets</label>
          <button id="ieSelectAll" type="button" style="font-size:12px;border:1px solid #d1d5db;border-radius:8px;padding:4px 8px;background:#fff">Select/Deselect All</button>
        </div>
        <div id="ieMarkets" class="chips" style="margin-top:6px"></div>
      </div>
    </div>
  </div>
  <div class="dlg-foot">
    <button id="ieCancel" type="button">Cancel</button>
    <button id="ieSave" class="primary" type="button">Save</button>
  </div>
</dialog>

<script>
  // ===== Local storage only =====
  const CACHE_KEY = 'groceries.cache.local.v1';
  let data = { markets: [], items: [], updatedAt: Date.now() };
  let dirty = false;
  let itemFilter = '';

  const makeId = () => (crypto.randomUUID?.() || (Date.now().toString(36) + Math.random().toString(36).slice(2)));
  const readCache = () => { try { const r = localStorage.getItem(CACHE_KEY); return r ? JSON.parse(r) : null; } catch { return null; } };
  const writeCache = (o) => { try { localStorage.setItem(CACHE_KEY, JSON.stringify(o)); } catch {} };
  const markDirty = () => { dirty = true; };

  const marketInput   = document.getElementById('marketInput');
  const addMarketBtn  = document.getElementById('addMarketBtn');
  const marketList    = document.getElementById('marketList');
  const itemInput     = document.getElementById('itemInput');
  const addItemBtn    = document.getElementById('addItemBtn');
  const marketChipsAdd= document.getElementById('marketChipsAdd');
  const itemsEl       = document.getElementById('items');
  const tpl           = document.getElementById('itemTpl');

  const dlg       = document.getElementById('itemEditor');
  const ieName    = document.getElementById('ieName');
  const ieMarkets = document.getElementById('ieMarkets');
  const ieSave    = document.getElementById('ieSave');
  const ieCancel  = document.getElementById('ieCancel');
  const ieSelectAll = document.getElementById('ieSelectAll');

  const saveBtn   = document.getElementById('saveBtn');
  const exportBtn = document.getElementById('exportBtn');
  const importBtn = document.getElementById('importBtn');
  const importFile= document.getElementById('importFile');

  function renderMarkets(){
    marketList.innerHTML = '';
    (data.markets || []).forEach(m => {
      const chip = document.createElement('span'); chip.className='chip'; chip.textContent=m;
      const del  = document.createElement('button'); del.textContent='üóë'; del.style.border='1px solid #e5e7eb'; del.style.borderRadius='8px'; del.style.padding='2px 6px';

      del.onclick = () => {
        const cnt = (data.items || []).filter(it => (it.markets || []).includes(m)).length;
        if(!confirm(`Delete market "${m}"? (${cnt} item(s) will be updated)`)) return;
        data.markets = data.markets.filter(x => x !== m);
        (data.items || []).forEach(it => it.markets = (it.markets || []).filter(x => x !== m));
        data.updatedAt = Date.now(); markDirty(); writeCache(data); renderMarkets(); renderAddChips(); renderItems();
      };

      chip.onclick = () => {
        const old = m;
        const nv = prompt('Rename market', old);
        if(!nv || !nv.trim() || nv === old) return;
        if(data.markets.some(x => x.toLowerCase() === nv.trim().toLowerCase())){ alert('Market name already exists.'); return; }
        data.markets = data.markets.map(x => x === old ? nv.trim() : x);
        (data.items || []).forEach(it => it.markets = (it.markets || []).map(x => x === old ? nv.trim() : x));
        data.updatedAt = Date.now(); markDirty(); writeCache(data); renderMarkets(); renderAddChips(); renderItems();
      };

      const wrap = document.createElement('span'); wrap.className='row'; wrap.style.gap='6px';
      wrap.appendChild(chip); wrap.appendChild(del); marketList.appendChild(wrap);
    });
  }

  function renderAddChips(){
    marketChipsAdd.innerHTML = '';
    (data.markets || []).forEach(m => {
      const lab = document.createElement('label'); lab.className='chip';
      lab.innerHTML = `<input type="checkbox" style="display:none"><span>${m}</span>`;
      lab.onclick = (e) => { if(e.target.tagName !== 'INPUT') e.preventDefault(); const inp = lab.querySelector('input'); inp.checked = !inp.checked; lab.classList.toggle('active', inp.checked); };
      marketChipsAdd.appendChild(lab);
    });
  }

  function renderItems(){
    const q = (itemFilter || '').trim().toLowerCase();
    itemsEl.innerHTML = '';

    const escapeHtml = s => s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    const highlight = (name, q) => {
      if(!q) return escapeHtml(name);
      const idx = name.toLowerCase().indexOf(q);
      if(idx === -1) return escapeHtml(name);
      const a = escapeHtml(name.slice(0, idx));
      const b = escapeHtml(name.slice(idx, idx + q.length));
      const c = escapeHtml(name.slice(idx + q.length));
      return `${a}<mark>${b}</mark>${c}`;
    };

    (data.items || []).forEach((it, idxOriginal) => {
      if(q && !it.name.toLowerCase().includes(q)) return;

      const row = tpl.content.cloneNode(true);
      row.querySelector('.name').innerHTML = highlight(it.name, q);

      const badges = row.querySelector('.badges'); badges.innerHTML = '';
      (it.markets || []).forEach(m => { const b = document.createElement('span'); b.className='badge'; b.textContent=m; badges.appendChild(b); });

      row.querySelector('.edit').onclick = () => openItemEditor(idxOriginal);
      row.querySelector('.del').onclick  = () => {
        if(confirm(`Delete "${it.name}"?`)){
          data.items.splice(idxOriginal, 1);
          data.updatedAt = Date.now(); markDirty(); writeCache(data); renderItems();
        }
      };

      itemsEl.appendChild(row);
    });
  }

  function renderAll(){ renderMarkets(); renderAddChips(); renderItems(); }

  addMarketBtn.onclick = () => {
    const name = (marketInput.value || '').trim(); if(!name) return;
    if((data.markets || []).some(x => x.toLowerCase() === name.toLowerCase())) { alert('Market already exists.'); return; }
    data.markets.push(name);
    marketInput.value = '';
    data.updatedAt = Date.now(); markDirty(); writeCache(data); renderMarkets(); renderAddChips();
  };

  itemInput.addEventListener('input', () => { itemFilter = itemInput.value || ''; renderItems(); });

  addItemBtn.onclick = () => {
    const raw = (itemInput.value || '');
    const names = raw.split(',').map(s => s.trim()).filter(Boolean);
    if(!names.length) return;

    const mkts = Array.from(marketChipsAdd.querySelectorAll('label.chip'))
      .filter(l => l.querySelector('input').checked)
      .map(l => l.textContent.trim());

    if(names.length === 1){
      const n = names[0];
      const idx = (data.items || []).findIndex(x => x.name.toLowerCase() === n.toLowerCase());
      if(idx >= 0){ if(confirm(`"${n}" already exists.\nOpen editor?`)) openItemEditor(idx); return; }
    }

    let added = 0;
    names.forEach(n => {
      const exists = data.items.some(x => x.name.toLowerCase() === n.toLowerCase());
      if(!exists){ data.items.push({id: makeId(), name: n, markets: mkts.slice(), checked: false, t: Date.now()}); added++; }
    });

    if(added === 0 && names.length > 1){ alert('All items already exist. (No new items added)'); }

    itemInput.value = ''; itemFilter = '';
    marketChipsAdd.querySelectorAll('.chip').forEach(ch => { ch.classList.remove('active'); ch.querySelector('input').checked = false; });

    if(added > 0){ data.updatedAt = Date.now(); markDirty(); writeCache(data); }
    renderItems();
  };

  const ieBuildChips = (current) => {
    ieMarkets.innerHTML = '';
    (data.markets || []).forEach(m => {
      const lab = document.createElement('label'); lab.className='chip';
      const checked = (current || []).includes(m);
      lab.innerHTML = `<input type="checkbox" ${checked ? 'checked' : ''} style="display:none"><span>${m}</span>`;
      if(checked) lab.classList.add('active');
      lab.onclick = (e) => { if(e.target.tagName !== 'INPUT') e.preventDefault(); const inp = lab.querySelector('input'); inp.checked = !inp.checked; lab.classList.toggle('active', inp.checked); };
      ieMarkets.appendChild(lab);
    });
  };

  const ieSelected = () => Array.from(ieMarkets.querySelectorAll('label.chip'))
    .filter(l => l.querySelector('input').checked)
    .map(l => l.textContent.trim());

  let editingIndex = -1;

  function openItemEditor(idx){
    editingIndex = idx; const it = data.items[idx];
    ieName.value = it.name; ieBuildChips(it.markets || []); dlg.showModal();
  }

  ieCancel.onclick = () => dlg.close();

  ieSelectAll.onclick = () => {
    const labels = Array.from(ieMarkets.querySelectorAll('label.chip'));
    const allChecked = labels.every(l => l.querySelector('input').checked);
    labels.forEach(l => { const inp = l.querySelector('input'); inp.checked = !allChecked; l.classList.toggle('active', inp.checked); });
  };

  ieSave.onclick = () => {
    if(editingIndex < 0) return;
    const name = (ieName.value || '').trim(); if(!name){ alert('Please enter a name.'); return; }
    const dup = data.items.some((x,i) => i !== editingIndex && x.name.toLowerCase() === name.toLowerCase());
    if(dup){ alert('An item with the same name already exists.'); return; }
    const it = data.items[editingIndex];
    it.name = name; it.markets = ieSelected(); it.t = Date.now();
    data.updatedAt = Date.now(); markDirty(); writeCache(data); renderItems(); dlg.close();
  };

  function handleBeforeUnload(e){ if(dirty){ e.preventDefault(); e.returnValue=''; } }
  window.addEventListener('beforeunload', handleBeforeUnload);

  document.getElementById('saveBtn').addEventListener('click', () => {
    try{
      data.updatedAt = Date.now(); writeCache(data);
      dirty = false; window.removeEventListener('beforeunload', handleBeforeUnload);
      location.href = 'index.html';
    }catch(e){ alert('Error while saving.'); }
  });

  // ===== Export / Import =====
  exportBtn.addEventListener('click', () => {
    const blob = new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
    const a = document.createElement('a'); a.download = `easycart-${new Date().toISOString().slice(0,10)}.json`;
    a.href = URL.createObjectURL(blob); a.click(); URL.revokeObjectURL(a.href);
  });

  importBtn.addEventListener('click', () => importFile.click());

  importFile.addEventListener('change', async () => {
    const f = importFile.files?.[0]; if(!f) return;
    try{
      const text = await f.text(); const j = JSON.parse(text);
      if(!Array.isArray(j.items) || !Array.isArray(j.markets)) throw new Error('Invalid format');
      data = j; data.updatedAt = Date.now(); writeCache(data); renderAll(); alert('Import completed');
    }catch(e){ alert('Import failed: ' + (e && e.message ? e.message : 'unknown')); }
    finally{ importFile.value = ''; }
  });

  (function boot(){
    const cached = readCache();
    if(cached){ data = cached; }
    renderAll();
  })();
</script>
</body>
</html>
