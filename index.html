<!-- =========================
쭌또카트 (로컬 전용)
- 동기화/비밀번호 제거
- localStorage만 사용
- 파일: index.html
========================= -->

<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>쭌또카트</title>
<link rel="apple-touch-icon" href="icon.png">
<link rel="icon" sizes="192x192" href="icon.png">
<meta name="theme-color" content="#166534">
<style>
*{box-sizing:border-box}
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,Apple SD Gothic Neo,'Malgun Gothic',sans-serif;margin:0;background:#f5f6f8;color:#111}
header.card{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid #e5e7eb}
.wrap{max-width:960px;margin:0 auto;padding:12px}
.card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:12px;margin:12px 0}
.row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.right{margin-left:auto}
.chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid #cbd5e1;background:#f8fafc;cursor:pointer;font-size:12px}
.chip.active{border-color:#16a34a;background:#ecfdf5}
.toggle{position:relative;width:50px;height:26px;border-radius:999px;background:#d1d5db;cursor:pointer;transition:background .25s;border:1px solid #cbd5e1}
.toggle::after{content:"";position:absolute;top:3px;left:3px;width:20px;height:20px;border-radius:50%;background:#fff;transition:transform .25s;box-shadow:0 1px 2px rgba(0,0,0,.15)}
.toggle.active{background:#166534}
.toggle.active::after{transform:translateX(24px)}
.list{display:grid;grid-template-columns:1fr;gap:8px}
@media(min-width:720px){.list{grid-template-columns:1fr 1fr}}
.item{display:flex;align-items:center;gap:10px;padding:10px;border:1px solid #e5e7eb;border-radius:12px;background:#fff}
.item.done .name{text-decoration:line-through;opacity:.7}
.item.done .badge{opacity:.6}
.badges{display:flex;gap:6px;flex-wrap:wrap}
.badge{font-size:11px;padding:2px 8px;border-radius:999px;border:1px solid #d1d5db;background:#f3f4f6;color:#374151}
a.edit{font-size:12px;border:1px solid #d1d5db;border-radius:10px;padding:6px 10px;text-decoration:none;color:#374151;background:#fff}
.muted{color:#6b7280;font-size:12px}
</style>
</head>
<body>
<header class="card">
  <div class="wrap">
    <div class="row">
      <div id="marketChips" class="row" style="gap:6px;flex-wrap:wrap"></div>

      <!-- 쇼핑 모드 라벨 포함 -->
      <div class="row" style="align-items:center;gap:6px">
        <div id="shoppingToggle" class="toggle" title="ON=사야 할 것만 보기"></div>
        <span class="muted">쇼핑 모드</span>
      </div>

      <a href="edit.html" class="right edit">편집</a>
    </div>
  </div>
</header>

<main class="wrap">
  <section class="card">
    <div id="list" class="list" aria-live="polite"></div>
  </section>
</main>

<template id="itemTpl">
  <label class="item">
    <input type="checkbox" />
    <div class="grow">
      <div class="row" style="justify-content:space-between">
        <strong class="name"></strong>
        <div class="badges"></div>
      </div>
    </div>
  </label>
</template>

<script>
  // ===== 로컬 스토리지 전용 상태 =====
  const CACHE_KEY = 'groceries.cache.local.v1';
  const list = document.getElementById('list');
  const tpl = document.getElementById('itemTpl');
  const marketChips = document.getElementById('marketChips');
  const shoppingToggle = document.getElementById('shoppingToggle');

  let data = { markets: [], items: [], updatedAt: Date.now() };
  let currentMarket = 'ALL';
  let shoppingMode = false;

  function readCache(){
    try{ const r=localStorage.getItem(CACHE_KEY); return r?JSON.parse(r):null; }catch{return null;}
  }
  function writeCache(o){
    try{ localStorage.setItem(CACHE_KEY, JSON.stringify(o)); }catch{}
  }

  function buildMarketChips(){
    marketChips.innerHTML='';
    const mk=(label,val,dim=false)=>{
      const b=document.createElement('button');
      b.className='chip';
      b.textContent=label;
      b.classList.toggle('active', currentMarket===val);
      if(dim) b.style.opacity=.75;
      b.onclick=()=>{
        currentMarket=val;
        [...marketChips.children].forEach(c=>c.classList.remove('active'));
        b.classList.add('active');
        render();
      };
      return b;
    };
    marketChips.appendChild(mk('모든 마켓','ALL',true));
    (data.markets||[]).forEach(m=> marketChips.appendChild(mk(m,m)));
  }

  function render(){
    list.innerHTML='';
    const m=currentMarket;
    (data.items||[]).forEach((item)=>{
      if(m!=='ALL' && !(item.markets||[]).includes(m)) return;
      if(shoppingMode && item.checked) return;

      const el=tpl.content.cloneNode(true);
      const label=el.querySelector('.item');
      const cb=el.querySelector('input[type=checkbox]');
      const name=el.querySelector('.name');
      const badges=el.querySelector('.badges');

      cb.checked=!!item.checked;
      name.textContent=item.name;
      badges.innerHTML='';
      (item.markets||[]).forEach(mm=>{
        const b=document.createElement('span');
        b.className='badge';
        b.textContent=mm;
        badges.appendChild(b);
      });
      if(item.checked) label.classList.add('done');

      cb.addEventListener('change', ()=>{
        item.checked=cb.checked;
        item.t = Date.now();
        data.updatedAt=Date.now();
        writeCache(data);
        render();
      });

      list.appendChild(el);
    });
  }

  shoppingToggle.addEventListener('click', ()=>{
    shoppingMode=!shoppingMode;
    shoppingToggle.classList.toggle('active', shoppingMode);
    render();
  });

  (function boot(){
    const cached=readCache();
    if(cached){ data=cached; }
    buildMarketChips();
    render();
  })();
</script>
</body>
</html>
